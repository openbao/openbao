---
sidebar_label: Control Groups
description: |-
  An OpenBao RFC for protecting paths by a control group
---

# Support control groups for authorizing paths

## Summary

This feature would implement second-party authorization for protected
resources. A control-group restriction placed on a path would require
a user to obtain prior authorization before the action would
succeed. 

Control groups utilize the existing response-wrapping workflow
(https://openbao.org/docs/concepts/response-wrapping/) because of the
asynchronous character, and usage would follow this general pattern (via API
endpoints):

1. A path is assigned a control-group policy
2. A user requesting the protected path receives a wrapped response with a `wrapping_accessor` and `wrapping_token`.
   1. The `wrapping_token` will not yet succeed to unwrap the response.
   2. The `wrapping_accessor` is used by control group members to approve the request.
3. Using the accessor, a control group member can review and authorize the request.
4. Access to the wrapped response via `wrapping_token` will now succeed.

A second phase might add a request/notification workflow, but this is not essential:
1. A user requests access to the protected resource
2. Members of the control group receive a notification of the request (on logging in to OpenBao web UI?)
3. The original requester receives notification of the control-group approval when it occurs

## Problem Statement

An organization wants to review access to certain paths (eg, pki
issuance, etc) on a case-by-case basis, and/or requires a "second set
of eyes" to approve access to a path. The reviewers are indicated by
specifying a "control group", whose member can grant access (by using
an endpoint). However, the control group members should not be able to
grant their own personal access.

## User-facing Description

## Technical Description

The control group implementation might consist of the following.
1. A control-group access policy:
   1. Denies data access by default
   2. Specifies the control group, number of authorizations, ttl
   2. Allows authorizing action to control group members
   3. Allows data access to authorized entity
2. An authorizing endpoint:
   1. Using wrapping accessor
   2. Self authorization not permitted
3. Authorization storage
   1. A mount for control-group
   2. Stores request and authorizations

## API Details

### Policy Extension

Control groups could be implemented as a new object in the ACL policy
for a path. Multiple named "factors" can be specified, eg:

```
path "pki/issue/*" {
  capabilities = ["create", "update"]

  control-group = {
    factor "pki-approvers" {
      identity {
		# Control groups that can authorize access
		group_names = ["pki-approvers", "security-team"]
		approvals = 1

		# Max duration for which authorization is valid
		ttl = "5d"

		# Allow self-authorization when true
		self_authorization = false
	  }
	}
  }
}
```

The resulting behaviors would look like the following:

```
# Normal request by jwt sub user-123 (blocked by control group by default)
POST /pki/issue/web-server
{
  "common_name": "web.example.com",
  "ttl": "24h"
}
```

Returns a wrapped response:
```
{
	"wrapping_token": "123-456-789",
	
}
```


# Authorization request, permitted if requesting jwt has the control group membership
POST /pki/issue/web-server/authorize
{
  "entity": "user-123",
  "ttl":    "1d",
  "reason": "Certificate renewal for production web service"
}

# Check authorization status for requesting entity (always reports status for current subject)
GET /pki/issue/web-server/authorize

POST /pki/issue/web-server (now permitted for user-123)
{
  "common_name": "web.example.com",
  "ttl": "24h"
}
```

## Rationale and Alternatives

This is essentially "assigning a policy to a resource and a user"
granting access -- which is something we can already do in OpenBao
with roles/policies/etc. However, the control-group concept has some
additional value:

1. The administrator can delegate authorization responsibility to a
   group, any member of which can grant access
2. By inhibiting self-approval, the control group policy can ensure "second set of eyes"
3. A workflow for requesting/granting in the UI might make admistration easier

## Downsides

## Security Implications

## User/Developer Experience

## Unresolved Questions

What is stored about an authorization? Where?
Do we need some kind of signing for authorizations?g

## Related Issues

- https://github.com/openbao/openbao/issues/1669

## Proof of Concept


