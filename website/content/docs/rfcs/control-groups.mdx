---
sidebar_label: Control Groups
description: |-
  An OpenBao RFC for protecting paths by a control group
---

# Support control groups for authorizing paths

## Summary

This feature would implement second-party authorization for protected
resources. A control-group restriction placed on a path would require
a user to obtain prior authorization before the action would succeed.

Using the control group feature would follow this general pattern, via API
endpoints:

1. A path is assigned a control-group policy
2. Access to the path is denied without control group authorization
3. A user belonging to the control group can authorize the resource for a particular entity
4. Access to the path is now permitted to the authorized entity for some duration

A second phase might add a request/notification workflow, but this is not essential:
1. A user requests access to the protected resource
2. Members of the control group receive a notification of the request (on logging in to OpenBao web UI?)
3. The original requester receives notification of the control-group approval when it occurs

## Problem Statement

An organization wants to review access to certain paths (eg, pki
issuance, etc) on a case-by-case basis, and/or requires a "second set
of eyes" to approve access to a path. The reviewers are indicated by
specifying a "control group", whose member can grant access (by using
an endpoint). However, the control group members should not be able to
grant their own personal access.

## User-facing Description

## Technical Description

The control group implementation might consist of the following.
1. A control-group access policy:
   1. Denies data access by default
   2. Specifies the control group, number of authorizations, ttl
   2. Allows authorizing action to control group members
   3. Allows data access to authorized entity
2. An authorizing endpoint:
   1. Applies to path
   2. Applies to user/entity
   3. Is time-limited
   4. Self authorization not permitted
3. Authorization storage (how do we maintain the "authorization" state over time?):
   1. Metadata on the path?
   2. Separate storage mount for authorizations?

When the policy is "checking authorization", we'd need to read the
authorization storage. This might be simplest if the metadata of the
path in question contains authorizations (no need to access a second
location).

For workflow, we might need a "requests" storage as well.

## API Details

### Policy Extension

Control groups could be implemented as a new stanza in the ACL policy for a path, eg:

```
path "pki/issue/*" {
  capabilities = ["create", "update"]

  control-group {
	# Control groups that can authorize access
	authorizers = ["pki-approvers", "security-team"]

	# Max duration for which authorization is valid
	ttl = "5d"

	# Allow self-authorization when true
	self_authorization = false

	# Optional: require multiple approvers
	required_approvals = 1

	# Optional: limit entities for which authorization can work
	authorized_entities = ["user-123", "service-account-web"]
  }
}
```

The specific endpoint behaviors could look like this:

```
# Normal request by jwt sub user-123 (blocked by control group by default)
POST /pki/issue/web-server
{
  "common_name": "web.example.com",
  "ttl": "24h"
}

# Authorization request, permitted if requesting jwt has the control group membership
POST /pki/issue/web-server/authorize
{
  "entity": "user-123",
  "ttl":    "1d",
  "reason": "Certificate renewal for production web service"
}

# Check authorization status for requesting entity (always reports status for current subject)
GET /pki/issue/web-server/authorize

POST /pki/issue/web-server (now permitted for user-123)
{
  "common_name": "web.example.com",
  "ttl": "24h"
}
```

## Rationale and Alternatives

This is essentially "assigning a policy to a resource and a user"
granting access -- which is something we can already do in OpenBao
with roles/policies/etc. However, the control-group concept has some
additional value:

1. The administrator can delegate authorization responsibility to a
   group, any member of which can grant access
2. By inhibiting self-approval, the control group policy can ensure "second set of eyes"
3. A workflow for requesting/granting in the UI might make admistration easier

## Downsides

## Security Implications

## User/Developer Experience

## Unresolved Questions

What is stored about an authorization? Where?
Do we need some kind of signing for authorizations?g

## Related Issues

- https://github.com/openbao/openbao/issues/1669

## Proof of Concept


